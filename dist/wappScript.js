!function(){console.log("Wapp script loaded");var e=null,t=null,n=document.createElement("link");n.href=chrome.runtime.getURL("mainStylesInject.css"),n.type="text/css",n.rel="stylesheet",document.getElementsByTagName("head")[0].appendChild(n),chrome.runtime.onMessage.addListener(((n,c,o)=>{"sendKey"===n.message?(e=n.savedSessionKey)&&h():"changeMode"===n.message?s():"getKeys"===n.message?o({sessionKey:e,savedPass:password}):n.credentials?(t=n.credentials.password?n.credentials.password:t,e=n.credentials.savedSessionKey?n.credentials.savedSessionKey:e,o({farewell:"Credenciales recibidas correctamente."})):"getKeys"===n.message&&o({savedPass:t,sessionKey:e})}));const c=(e,t)=>{for(let t of e)"childList"===t.type&&t.addedNodes.forEach((e=>{if("main"===e.id){const e=document.querySelectorAll(".copyable-area");e[1]&&(h(),d(e[1]))}}))},o={childList:!0,subtree:!0};let a=null,i=!1;function s(){a||(a=new MutationObserver(c)),i||(a.observe(document.body,o),i=!0)}function r(){a&&(a.disconnect(),i=!1)}function d(e){if("true"===e.getAttribute("data-duplicated"))return;const t=document.createElement("div");t.id="containerDiv";const n=document.createElement("div"),c=document.createElement("div"),o=document.createElement("div");n.id="leftDiv",c.id="centerDiv",o.id="rightDiv";const a=document.createElement("input");a.type="text",a.id="inputText",a.placeholder="Encrypt to protect...",a.addEventListener("keyup",(async function(e){if("Enter"===e.key){e.stopPropagation(),e.preventDefault();const t=a.value;if(t){const e=await y(t);await w(e),a.value="",h(),a.focus()}}})),c.appendChild(a);let i=new Image;i.id="hcLogo",i.src=chrome.runtime.getURL("/assets/hatChat-128.png"),n.appendChild(i);const s=document.createElement("img");s.src=chrome.runtime.getURL("/assets/send.png"),s.id="icon",o.appendChild(s),s.addEventListener("click",(async function(e){const t=a.value;if(t){const e=await y(t);e&&(await w(e),a.value="",h())}})),t.appendChild(n),t.appendChild(c),t.appendChild(o),e.appendChild(t),e.setAttribute("data-duplicated","true"),mainTargetDiv=document.querySelector("footer > .copyable-area"),mainTargetDiv.style.opacity="0",document.querySelector('div[role="application"] ').addEventListener("keydown",(e=>{a.focus()})),document.querySelectorAll('div[role="listitem"]').forEach((e=>{e.addEventListener("click",(e=>{setTimeout((()=>{a.focus()}),100),a.focus()}))})),document.getElementById("pane-side").addEventListener("keydown",(e=>{setTimeout((()=>{a.focus()}),100),setTimeout((()=>{a.focus()}),1),setTimeout((()=>{a.focus()}),500),a.focus()}));const r=document.getElementById("app"),d=new MutationObserver(((e,t)=>{for(const t of e)"childList"===t.type&&r.querySelectorAll("li").forEach(((e,t)=>{e.getAttribute("data-event-added")||(e.setAttribute("data-event-added","true"),e.addEventListener("click",(e=>{setTimeout((()=>{a.focus()}),100),setTimeout((()=>{a.focus()}),1),setTimeout((()=>{a.focus()}),500)})))}))})),u=document.getElementById("main");u.addEventListener("keydown",(e=>{setTimeout((()=>{a.focus(),a.click()}),1)})),u.addEventListener("keyup",(e=>{setTimeout((()=>{a.focus(),a.click()}),1)})),d.observe(r,{attributes:!1,childList:!0,subtree:!0})}async function u(e){const t=new Uint8Array(e.match(/.{1,2}/g).map((e=>parseInt(e,16))));return await window.crypto.subtle.importKey("raw",t,{name:"AES-GCM"},!1,["encrypt","decrypt"])}async function l(e,t){let n=(new TextEncoder).encode(e),c=window.crypto.getRandomValues(new Uint8Array(12)),o=await window.crypto.subtle.encrypt({name:"AES-GCM",iv:c},t,n),a=new Uint8Array(c.byteLength+o.byteLength);return a.set(new Uint8Array(c),0),a.set(new Uint8Array(o),c.byteLength),i=a,btoa(String.fromCharCode.apply(null,new Uint8Array(i)));var i}async function m(e,t){let n=function(e){let t=atob(e),n=t.length,c=new Uint8Array(n);for(let e=0;e<n;e++)c[e]=t.charCodeAt(e);return c.buffer}(e),c=n.slice(0,12),o=n.slice(12),a=await window.crypto.subtle.decrypt({name:"AES-GCM",iv:c},t,o);return(new TextDecoder).decode(a)}async function y(t){const n=document.getElementById("inputText");if(n.focus(),n.click(),!e){try{await p().catch((e=>{alert("No chat selected")}))}catch(e){return}if(!e)return}try{const n=await u(e);return await l(t,n)}catch(e){}}async function f(t){if(!e)try{await p().catch((e=>{}))}catch(e){return}try{const n=await u(e);return await m(t,n)}catch(e){}}async function p(){return new Promise(((t,n)=>{chrome.runtime.sendMessage({message:"getSessionKey"},(function(c){c&&c.sessionKey?(e=c.sessionKey,t()):n("No session key found")}))}))}async function w(e){const t=document.getElementById("inputText"),n=e.split(/[\n\t]+/).map((e=>e.trim())).filter((e=>e)),c=document.querySelector("#main").querySelector('div[contenteditable="true"]');if(!c)throw new Error("No chat found");c.focus(),document.execCommand("selectAll",null,!1),setTimeout((()=>{document.execCommand("insertText",!1,"")}),10);for(const e of n)c.focus(),document.execCommand("insertText",!1,e),c.dispatchEvent(new Event("input",{bubbles:!0})),await new Promise((e=>setTimeout(e,100))),document.querySelector('span[data-icon="send"]').click(),n.indexOf(e)!==n.length-1&&await new Promise((e=>setTimeout(e,250))),setTimeout((()=>{t.focus(),t.click()}),50)}async function h(){const t=document.getElementById("inputText");document.querySelectorAll("div[aria-selected]").forEach((e=>{e.addEventListener("click",(e=>{setTimeout((()=>{t.focus(),t.click()}),100)}))}));const n=document.getElementById("main");n.addEventListener("keydown",(e=>{setTimeout((()=>{t.focus(),t.click()}),1)})),n.addEventListener("keyup",(e=>{setTimeout((()=>{t.focus(),t.click()}),1)})),e||p().catch((e=>{}));const c=document.querySelectorAll('span[dir="ltr"]');for(const e of c){const t=e.innerText;if(/^(?:[A-Za-z0-9+\/]{4})*(?:[A-Za-z0-9+\/]{2}==|[A-Za-z0-9+\/]{3}=)?$/.test(t))try{const n=await f(t);n&&n!==t&&(e.innerText=n)}catch(n){e.innerText=t}}setTimeout(h,1500)}chrome.storage.onChanged.addListener((function(e,t){for(var n in e){var c=e[n];"activated"===n&&(c.newValue?s():r(),window.location.reload())}})),chrome.storage.local.get(["activated"],(function(e){e.activated?s():r()})),chrome.runtime.sendMessage({message:"getSessionKey"},(async function(t){e=t.sessionKey;try{const t=await u(e),n=await l("Hola",t);await m(n,t)}catch(e){}}))}();