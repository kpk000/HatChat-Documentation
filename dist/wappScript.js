!function(){console.log("Wapp script loaded");var e=null,t=null,n=document.createElement("link");n.href=chrome.runtime.getURL("mainStylesInject.css"),n.type="text/css",n.rel="stylesheet",document.getElementsByTagName("head")[0].appendChild(n),chrome.runtime.onMessage.addListener(((n,a,c)=>{"sendKey"===n.message?(e=n.savedSessionKey)&&h():"changeMode"===n.message?s():"getKeys"===n.message?c({sessionKey:e,savedPass:password}):n.credentials?(console.log("Credenciales recibidas en el wappScript:"),t=n.credentials.password?n.credentials.password:t,e=n.credentials.savedSessionKey?n.credentials.savedSessionKey:e,c({farewell:"Credenciales recibidas correctamente."})):"getKeys"===n.message&&(console.log("Recibida petición de clave de sesión en wapp"),c({savedPass:t,sessionKey:e}))}));const a=(e,t)=>{for(let t of e)"childList"===t.type&&t.addedNodes.forEach((e=>{if("main"===e.id){const e=document.querySelector("._2lSWV._3cjY2.copyable-area");e&&(h(),d(e))}}))},c={childList:!0,subtree:!0};let i=null,o=!1;function s(){i||(i=new MutationObserver(a)),o||(i.observe(document.body,c),o=!0)}function r(){i&&(i.disconnect(),o=!1)}function d(e){if("true"===e.getAttribute("data-duplicated"))return;const t=document.createElement("div");t.id="containerDiv";const n=document.createElement("div"),a=document.createElement("div"),c=document.createElement("div");n.id="leftDiv",a.id="centerDiv",c.id="rightDiv";const i=document.createElement("input");i.type="text",i.id="inputText",i.placeholder="Encrypt to protect...",i.addEventListener("keyup",(async function(e){if("Enter"===e.key){e.stopPropagation(),e.preventDefault();const t=i.value;if(t){const e=await y(t);await w(e),i.value="",h(),i.focus()}}})),a.appendChild(i);let o=new Image;o.id="hcLogo",o.src=chrome.runtime.getURL("/assets/hatChat-128.png"),n.appendChild(o);const s=document.createElement("img");s.src=chrome.runtime.getURL("/assets/send.png"),s.id="icon",c.appendChild(s),s.addEventListener("click",(async function(e){const t=i.value;if(t){const e=await y(t);e&&(await w(e),i.value="",h())}})),t.appendChild(n),t.appendChild(a),t.appendChild(c),e.appendChild(t),e.setAttribute("data-duplicated","true"),mainTargetDiv=document.querySelector("._3Uu1_"),mainTargetDiv.style.opacity="0",document.querySelector('div[role="application"] ').addEventListener("keydown",(e=>{i.focus()})),document.querySelectorAll('div[role="listitem"]').forEach((e=>{e.addEventListener("click",(e=>{setTimeout((()=>{i.focus()}),100),i.focus()}))})),document.getElementById("pane-side").addEventListener("keydown",(e=>{setTimeout((()=>{i.focus()}),100),setTimeout((()=>{i.focus()}),1),setTimeout((()=>{i.focus()}),500),i.focus()}));const r=document.getElementById("app");new MutationObserver(((e,t)=>{for(const t of e)"childList"===t.type&&r.querySelectorAll("li").forEach(((e,t)=>{e.getAttribute("data-event-added")||(e.setAttribute("data-event-added","true"),e.addEventListener("click",(e=>{setTimeout((()=>{i.focus()}),100),setTimeout((()=>{i.focus()}),1),setTimeout((()=>{i.focus()}),500),console.log("responder clicado")})))}))})).observe(r,{attributes:!1,childList:!0,subtree:!0})}async function u(e){const t=new Uint8Array(e.match(/.{1,2}/g).map((e=>parseInt(e,16))));return await window.crypto.subtle.importKey("raw",t,{name:"AES-GCM"},!1,["encrypt","decrypt"])}async function l(e,t){let n=(new TextEncoder).encode(e),a=window.crypto.getRandomValues(new Uint8Array(12)),c=await window.crypto.subtle.encrypt({name:"AES-GCM",iv:a},t,n),i=new Uint8Array(a.byteLength+c.byteLength);return i.set(new Uint8Array(a),0),i.set(new Uint8Array(c),a.byteLength),o=i,btoa(String.fromCharCode.apply(null,new Uint8Array(o)));var o}async function m(e,t){let n=function(e){let t=atob(e),n=t.length,a=new Uint8Array(n);for(let e=0;e<n;e++)a[e]=t.charCodeAt(e);return a.buffer}(e),a=n.slice(0,12),c=n.slice(12),i=await window.crypto.subtle.decrypt({name:"AES-GCM",iv:a},t,c);return(new TextDecoder).decode(i)}async function y(t){const n=document.getElementById("inputText");if(n.focus(),n.click(),!e){try{await f().catch((e=>{alert("No chat selected")}))}catch(e){return}if(!e)return}try{const n=await u(e);return await l(t,n)}catch(e){}}async function p(t){if(!e)try{await f().catch((e=>{}))}catch(e){return}try{const n=await u(e);return await m(t,n)}catch(e){}}async function f(){return new Promise(((t,n)=>{chrome.runtime.sendMessage({message:"getSessionKey"},(function(a){a&&a.sessionKey?(e=a.sessionKey,t()):n("No session key found")}))}))}async function w(e){const t=document.querySelector("._3Uu1_"),n=(t.getElementsByTagName("p"),document.getElementById("inputText"));t.addEventListener("keydown",(e=>{"Enter"===e.key&&setTimeout((()=>{n.focus(),n.click()}),1)})),t.addEventListener("keyup",(e=>{"Enter"===e.key&&setTimeout((()=>{n.focus(),n.click()}),1)}));const a=e?.split(/[\n\t]+/).map((e=>e.trim())).filter((e=>e));if(main=document.querySelector("#main"),textarea=main.querySelector('div[contenteditable="true"]'),!textarea)throw new Error("No chat found");if(a)for(const e of a)textarea.focus(),document.execCommand("insertText",!1,e),textarea.dispatchEvent(new Event("change",{bubbles:!0})),setTimeout((()=>{(main.querySelector('[data-testid="send"]')||main.querySelector('[data-icon="send"]')).click()}),100),a.indexOf(e)!==a?.length-1&&await new Promise((e=>setTimeout(e,250)));setTimeout((()=>{n.focus(),n.click()}),50)}async function h(){e||f().catch((e=>{console.log(e)}));const t=document.querySelectorAll("._11JPr.selectable-text.copyable-text");for(const e of t){const t=e.innerText;if(/^(?:[A-Za-z0-9+\/]{4})*(?:[A-Za-z0-9+\/]{2}==|[A-Za-z0-9+\/]{3}=)?$/.test(t))try{const n=await p(t);n&&n!==t&&(e.innerText=n)}catch(n){e.innerText=t}}setTimeout(h,1500)}chrome.storage.onChanged.addListener((function(e,t){for(var n in e){var a=e[n];"activated"===n&&(a.newValue?s():r(),window.location.reload())}})),chrome.storage.local.get(["activated"],(function(e){e.activated?s():r()})),chrome.runtime.sendMessage({message:"getSessionKey"},(async function(t){e=t.sessionKey;try{const t=await u(e),n=await l("Hola",t);await m(n,t)}catch(e){}}))}();